# 3.基准测试提示词长度选定合理性分析

## 一、论证对象
### 1.1 问题背景
端侧LLM推理基准测试中，提示词长度是影响测试稳定性和效率的关键参数。传统选择缺乏科学依据，需系统性测试确定合理长度范围。

### 1.2 核心问题
- **短提示词**：Decode波动大，方差高，稳定性差
- **长提示词**：测试时间长，效率低，不适合大规模测试
- **目标**：找到稳定性和效率的最佳平衡

### 1.3 分析范围
- **验证重点**：提示词长度对测试稳定性和效率的影响规律
- **评估指标**：Prefill/Decode速度、CV变化、测试时间
- **测试环境**：详见3.6统一配置
- **排除范围**：不涉及生成内容质量，仅关注性能表现

## 二、论证方法
### 2.1 总体论证思路
**基于五阶段现象发现方法观察提示词长度的收敛现象，以边际效益递减为核心评判原则**

**方法论依据：**
- **趋势发现原理**：广泛采样识别CV变化的完整模式
- **现象观察方法**：阶段性探测，发现从快速改善到稳定的转折现象
- **边际效益原理**：关注收益递减点，而非绝对的最优解

### 2.2 实验设计

#### 2.2.1 五阶段测试策略

| 阶段 | 目标 | 采样策略 | 重复次数 |
|------|------|----------|-----------|
| 0 | 参数优化 | 测试32/64/128生成长度 | 10 |
| 1 | 趋势扫描 | 8-512广泛采样 | 10 |
| 2 | 现象探测 | 关键变化区密集采样 | 10 |
| 3 | 效益验证 | 收敛点延伸验证 | 15 |
| 4 | 一致性 | 多模型验证 | 20 |

#### 采样策略说明
**阶段0（参数优化）**：测试32/64/128生成长度，确定最优参数
**阶段1（趋势扫描）**：8-512广泛采样，小长度密布，大长度稀疏
**阶段2（现象探测）**：关键变化区[48-128]密集采样，跟踪收敛现象
**阶段3（效益验证）**：收敛点延伸验证，确认收益递减
**阶段4（一致性）**：多模型验证现象普适性

**关键检测指标**：
- 收敛现象：连续3-4点CV变化 < 10%
- 边际效益：CV改善幅度 < 5%

#### 控制变量
- **模型配置**：详见3.6测试环境配置
- **统计要求**：MNN_LLM_Benchmark自动计算统计值
- **环境一致性**：所有测试使用统一环境确保可比性

#### 2.2.2 参数优化预实验
**目标**：确定最优生成长度（32/64/128）

**测试策略**：
| 生成长度 | 提示词长度范围 | 重复次数 | 指标 |
|----------|---------------|-----------|------|
| 32 | 8-16, 32-48, 64-128 | 10 | CV敏感度、噪音、效率 |
| 64 | 8-16, 32-48, 64-128 | 10 | CV敏感度、噪音、效率 |
| 128 | 8-16, 32-48, 64-128 | 10 | CV敏感度、噪音、效率 |

**选择标准**：高敏感度、低噪音、合理效率

### 2.3 收敛判定标准
**核心原则**：识别CV变化率的收敛现象，非固定阈值

**判定指标**：
- **收敛现象**：连续3-4点CV变化 < 10%
- **边际效益**：继续增加长度CV改善 < 5%
- **普适性**：所有模型都应观察到收敛现象

## 三、论证过程
### 3.1 阶段0：参数优化预实验
**目标**：通过三步筛选法，确定最优生成长度（32/64/128）

**3.1.1 数据采集规范**
**核心测量指标**：LLM_bench直接测量的生成速度（tg值）及其稳定性

**测量原理**：
- **tg数据**：LLM_bench测量的生成速度（token/秒）
- **tg的CV**：tg数据的变异系数，衡量生成速度的相对波动程度
- **物理意义**：tg的CV越低，说明该实验配置下的推理性能越稳定
- **优势**：直接使用测量值，避免时间转换引入的误差

**数据采集方法**：
- **测量对象**：LLM_bench输出的tg值（生成速度）
- **数据处理**：每组重复10次，记录tg值和标准差，计算tg的CV
- **计算公式**：`tg_CV = std(tg数据) / mean(tg数据)`
- **实验分组**：3个提示词长度区间 × 3个生成长度 × 10次重复

**实验分组示例**：
```
生成长度32：
- 组1：生成长度32 + 提示词区间[8-16]
  → 测试提示词长度：8(5次) + 16(5次)
  → 得到10个tg数据 → 计算tg_CV_8-16

- 组2：生成长度32 + 提示词区间[32-48]
  → 测试提示词长度：32(5次) + 48(5次)
  → 得到10个tg数据 → 计算tg_CV_32-48

- 组3：生成长度32 + 提示词区间[64-128]
  → 测试提示词长度：64(5次) + 128(5次)
  → 得到10个tg数据 → 计算tg_CV_64-128
```

**3.1.2 三步筛选法**

**第1步：稳定性检查**
- **标准**：所有区间的tg的CV ≤ 15%
- **物理意义**：测量工具本身足够稳定
- **筛选逻辑**：任一生成长度如果有一个区间CV > 15%，直接淘汰

**第2步：区分能力检查**
- **标准**：长短区间差异 ≥ 20%
- **计算方式**：`(tg_CV_短区间 - tg_CV_长区间) / tg_CV_短区间 ≥ 20%`
- **物理意义**：能够区分不同提示词长度的影响
- **筛选逻辑**：无法达到20%差异的生成长度淘汰

**第3步：效率优化选择**
- **标准**：实际测试时间最短
- **计算方式**：实际测试时间 = 生成长度 ÷ 平均tg值
- **物理意义**：完成基准测试的实际时间成本
- **选择逻辑**：在前两步筛选通过的基础上，选择测试时间最短的

**3.1.3 数据记录与决策**
**数据记录表**：
| 生成长度 | CV_短区间 | CV_中区间 | CV_长区间 | 平均tg值 | 最大CV | 长短差异 | 测试时间 |
|---------|----------|----------|----------|---------|-------|---------|---------|
| 32      | X%       | Y%       | Z%       | T₁      | M₁%   | Diff₁%  | Time₁   |
| 64      | A%       | B%       | C%       | T₂      | M₂%   | Diff₂%  | Time₂   |
| 128     | P%       | Q%       | R%       | T₃      | M₃%   | Diff₃%  | Time₃   |

**决策过程记录**：
```
第1步：稳定性检查
□ 32通过（最大CV = M₁% ≤ 15%）
□ 64通过（最大CV = M₂% ≤ 15%）
□ 128淘汰（最大CV = M₃% > 15%）

第2步：区分能力检查
□ 32通过（长短差异 = Diff₁% ≥ 20%）
□ 64通过（长短差异 = Diff₂% ≥ 20%）

第3步：效率优化选择
32测试时间 = Time₁秒，64测试时间 = Time₂秒
选择____（测试时间更短）

最终决策：选择生成长度__，原因：____
```

**3.1.4 方案说明**
**关键优势**：
- 操作简单：无复杂数学计算，直观的筛选逻辑
- 目标明确：每步筛选目标清晰，物理意义容易理解
- 实用性强：基于实际测试需求，考虑时间成本因素

**详细备选方案**：如需更复杂的科学论证，请参考测试配置目录中的备选方案

**进入下一阶段条件**：
- 生成长度通过三步筛选确定
- 实际测试结果记录完整
- 筛选逻辑验证清晰

---

### 3.2 阶段1：全局趋势扫描
**目标**：识别CV整体变化模式

**实验内容**：
- 使用确定的生成长度，测试提示词长度：8,16,24,32,40,48,56,64,72,80,88,96,112,128,160,192,256,384,512
- 每个长度重复10次，记录Prefill/Decode速度、CV值、测试时间
- 分析CV变化斜率，识别从快速变化到平缓的转折区间

**预期分析**：
- 小长度区CV变化率大，大长度区趋于平稳
- 找出CV变化率的关键转折区间（如[48,128]）

**决策标准**：
- 识别CV变化的关键转折区间，为阶段2提供目标范围
- __人工填写结论__：[识别的转折区间及分析结果]

**进入下一阶段条件**：
- 转折区间明确，阶段2测试范围确定

---

### 3.3 阶段2：收敛现象探测
**目标**：在关键变化区检测首次收敛现象

**实验内容**：
- 基于阶段1识别的转折区间（如[48,128]）
- 在该区间内密集采样：[48,56,64,72,80,88,96,104,112,120,128]
- 每个长度重复10次，重点观察CV变化幅度

**检测指标**：
- **收敛现象计算**：连续3-4点CV变化 < 10%
- **边际效益计算**：CV改善幅度 < 5%

**3.2.1 收敛现象计算方法**
- **定义**：CV值在连续长度点上的变化幅度
- **计算方式**：
  ```
  CV变化率 = |CV(i+1) - CV(i)| / CV(i)

  收敛判断：
  如果连续k个点满足 CV变化率 < 10%，则认为收敛
  ```
- **平台现象检测**：
  ```
  搜索最长的连续区间，满足：
  max(CV[区间]) - min(CV[区间]) / mean(CV[区间]) < 10%
  ```

**3.2.2 边际效益计算方法**
- **定义**：继续增加提示词长度带来的CV改善幅度
- **计算方式**：
  ```
  边际效益 = (CV(i) - CV(i+1)) / CV(i)

  收益递减判断：
  如果边际效益 < 5%，则认为收益递减
  ```

**3.2.3 梯度分析方法**
- **一阶梯度**：CV变化的斜率，`gradient = d(CV)/d(length)`
- **收敛判定**：|gradient| < 0.05（接近水平）
- **拐点检测**：`gradient`符号变化的点

**预期分析**：
- 在中长度区间首次检测到收敛现象
- 梯度接近零，形成平台现象

**决策标准**：
- 明确检测到首次收敛现象：连续3-4点CV变化 < 10%
- 收敛位置有效：非边界收敛，且重复测试稳定
- __人工填写结论__：[收敛现象首次出现位置及具体计算结果]

**进入下一阶段条件**：
- 收敛现象位置确定，验证其稳定性和边际效益

---

### 3.4 阶段3：边际效益验证
**目标**：验证收敛后的收益递减规律

**实验内容**：
- 基于阶段2识别的收敛点（如64）
- 延伸测试：[64+0, 64+32, 64+64, 64+96, 64+128]等
- 验证收敛点后的CV改善是否持续且显著

**3.3.1 边际效益验证计算**
- **时间-效益权衡**：
  ```
  边际效益率 = CV改善幅度 / 测试时间增长
  价值判断 = 边际效益率 / 基准效益率
  ```
- **收益递减确认**：
  ```
  连续3个长度点的边际效益 < 5%
  且递减趋势持续
  ```

**3.3.2 成本效益分析**
- **时间成本**：测试时间随长度增长的函数关系
- **效益期望**：CV改善的理论期望与实际对比
- **拐点确认**：效益/成本比开始下降的点

**验证重点**：
- CV改善幅度是否持续低于5%
- 测试时间增长是否超过收益的2倍
- 效益/成本曲线的拐点位置

**3.3.3 终止条件量化**
- **时间终止**：`time_growth > 2 * benefit_improvement`
- **效益终止**：`marginal_benefit < 5% for 3+ points`
- **综合判断**：效益成本比下降超过阈值

**预期分析**：
- 收敛点后边际效益明显递减
- 继续增加长度价值不大

**决策标准**：
- 确认边际效益递减现象，验证继续增加的必要性
- __人工填写结论__：[边际效益验证结果及具体计算数据]

**进入下一阶段条件**：
- 边际效益递减确认，准备验证多模型一致性

---

### 3.5 阶段4：多模型一致性验证
**目标**：确认收敛现象在不同模型间的普适性

**实验内容**：
- 在Qwen3-1.8B-MNN和Qwen3-VL-2B-MNN上
- 使用相同的生成长度和关键长度点
- 验证所有模型是否都能观察到收敛现象

**3.4.1 一致性量化指标**
- **现象存在一致性**：
  ```
  一致性得分 = (存在收敛现象的模型数 / 总模型数) * 100%
  要求：一致性得分 >= 80%
  ```

- **收敛位置一致性**：
  ```
  位置差异 = max(convergence_point) - min(convergence_point)
  相对差异 = 位置差异 / min(convergence_point)
  要求：相对差异 <= 50%
  ```

- **收敛程度一致性**：
  ```
  收敛CV差异 = std(convergence_CVs) / mean(convergence_CVs)
  要求：收敛CV差异 <= 20%
  ```

**3.4.2 跨模型相关性分析**
- **相关性计算**：
  ```
  Pearson相关系数 = corr(CV_model1, CV_model2)
  要求：相关系数 >= 0.7
  ```

- **方差分析**：
  ```
  组间方差占比 = 组间方差 / 总方差
  要求：组内方差占比 > 组间方差占比
  ```

**验证重点**：
- 收敛现象的普遍存在性（位置可不同）
- 收敛后边际效益递减的一致性
- 参数设置的跨模型适用性

**3.4.3 参数通用性判断**
- **统一参数条件**：
  ```
  通用性判断 = (收敛现象存在 + 位置差异合理 + 程度一致)
  ```

**预期分析**：
- 不同模型收敛位置可能有差异，但现象应该普遍存在
- 收敛现象的规律具有跨模型一致性

**决策标准**：
- 现象一致性确认：一致性得分 >= 80%
- 参数通用性确认：位置差异 <= 50%
- __人工填写结论__：[跨模型一致性验证结果及具体计算]

**项目完成标准**：
- 五阶段测试全部完成，规律总结完成

---

### 3.6 测试环境配置
**硬件环境**：
- **处理器**：FT D3000（8核）
- **内存**：32GB
- **存储**：SSD（确保I/O性能）

**软件环境**：
- **推理引擎**：MNN推理引擎（版本由实际执行时确定）
- **操作系统**：Linux环境
- **依赖库**：MNN_LLM_Benchmark框架

**测试模型**：
- **主验证模型**：Qwen3-0.6B-MNN（完整测试序列）
- **验证模型**：Qwen3-1.8B-MNN、Qwen3-VL-2B-MNN（一致性验证）

**固定参数**：
- **线程数**：4
- **提示词模式**：固定提示词模式
- **生成长度**：__预实验确定__
- **环境控制**：统一硬件、软件、参数配置确保可比性

**备注**：所有阶段均使用此环境配置，确保测试结果的一致性和可比性

## 四、论证结论
### 4.1 实验发现总结
**4.1.1 生成长度优化结果**
- __人工填写__：[最终选择的生成长度及详细依据分析]

**4.1.2 CV收敛现象验证**
- __人工填写__：[是否观察到明确的CV收敛现象，首次出现位置]
- __人工填写__：[收敛现象的具体特征描述，与预期是否一致]

**4.1.3 多模型一致性分析**
- __人工填写__：[不同模型的收敛现象是否一致，差异性分析]
- __人工填写__：[跨模型通用性结论]

**4.1.4 关键数值结果**
| 提示词长度 | Qwen3-0.6B CV | Qwen3-1.8B CV | Qwen3-VL-2B CV | 收敛判断 |
|------------|---------------|---------------|----------------|----------|
| __人工填写数据表__ |

### 4.2 参数选择建议
**4.2.1 主要推荐参数**
- __人工填写__：[基于实验结果的主要推荐提示词长度]
- __人工填写__：[选择的生成长度参数]
- __人工填写__：[选择的线程数等配置参数]

**4.2.2 分类应用策略**
| 应用场景 | 推荐策略 | 具体参数 | 使用说明 |
|----------|-----------|----------|----------|
| 基准研究 | [人工填写] | [人工填写] | [人工填写] |
| 效率优先 | [人工填写] | [人工填写] | [人工填写] |
| 高精度需求| [人工填写] | [人工填写] | [人工填写] |

**4.2.3 模型差异化建议**
- __人工填写__：[是否需要为不同模型提供差异化参数]
- __人工填写__：[特殊情况（如VL模型）的处理方案]

## 附录
### A.1 执行命令
```bash
cd 测试配置/
python3 ~/MNN_LLM_Benchmark/framework/benchmark.py -b prompt_length_test.yaml
```

### A.2 判定标准
- **收敛现象**：连续3-4点CV变化 < 10%
- **边际效益**：CV改善 < 5%
- **普适性**：所有模型观察收敛现象

---

**文档版本**: v2.0  **最后更新**: 2025年11月19日  **EAO基准测试项目团队**
